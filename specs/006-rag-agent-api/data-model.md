# Data Model: RAG Agent and API Service

**Feature**: RAG Agent and API Service
**Created**: 2025-12-24
**Branch**: `006-rag-agent-api`
**Related Spec**: [specs/006-rag-agent-api/spec.md](specs/006-rag-agent-api/spec.md)

## Overview

This document defines the data models for the RAG Agent and API Service, including request/response schemas, entity relationships, and data flow patterns. The models ensure consistent data handling across the API layer, agent processing, and vector retrieval components.

## Core Entities

### 1. Query Request

**Purpose**: Represents a user's question and associated parameters for the RAG agent.

**Schema**:
```python
class QueryRequest(BaseModel):
    query: str
        description: "The user's question or query text"
        constraints: "Required, 1-1000 characters"
        example: "What are the key principles of humanoid robotics?"

    max_chunks: int = 5
        description: "Maximum number of document chunks to retrieve"
        constraints: "Optional, default 5, range 1-10"
        example: 3

    temperature: float = 0.1
        description: "Temperature parameter for response generation"
        constraints: "Optional, default 0.1, range 0.0-1.0"
        example: 0.2

    include_sources: bool = True
        description: "Whether to include source citations in response"
        constraints: "Optional, default True"
        example: True

    timeout: int = 30
        description: "Request timeout in seconds"
        constraints: "Optional, default 30, range 5-60"
        example: 45
```

**Validation Rules**:
- Query must be non-empty and not exceed 1000 characters
- max_chunks must be between 1 and 10
- temperature must be between 0.0 and 1.0
- timeout must be between 5 and 60 seconds

### 2. Retrieved Context

**Purpose**: Contains document chunks retrieved from the vector database that are relevant to the query.

**Schema**:
```python
class RetrievedChunk(BaseModel):
    content: str
        description: "The text content of the retrieved chunk"
        constraints: "Required"
        example: "Humanoid robotics involves creating robots with human-like characteristics..."

    source_url: str
        description: "URL of the original document"
        constraints: "Required"
        example: "https://physical-ai-humanoid-robotics-book-dusky.vercel.app/docs/introduction"

    source_title: str
        description: "Title of the original document"
        constraints: "Required"
        example: "Introduction to Humanoid Robotics"

    chunk_position: int
        description: "Position of this chunk within the original document"
        constraints: "Required, non-negative"
        example: 1

    similarity_score: float
        description: "Similarity score from vector search (0.0-1.0)"
        constraints: "Required, range 0.0-1.0"
        example: 0.85

    metadata: Dict[str, Any]
        description: "Additional metadata about the chunk"
        constraints: "Optional"
        example: {"section": "chapter-1", "keywords": ["introduction", "overview"]}

class RetrievedContext(BaseModel):
    chunks: List[RetrievedChunk]
        description: "List of relevant document chunks"
        constraints: "Required, 1-10 chunks"
        example: "[{...chunk1...}, {...chunk2...}]"

    total_chunks_found: int
        description: "Total number of chunks found before filtering"
        constraints: "Required, non-negative"
        example: 25

    search_time_ms: float
        description: "Time taken for vector search in milliseconds"
        constraints: "Required, positive"
        example: 45.2
```

**Validation Rules**:
- RetrievedContext must contain at least 1 chunk and no more than 10 chunks
- similarity_score must be between 0.0 and 1.0
- chunk_position must be non-negative
- search_time_ms must be positive

### 3. Agent Response

**Purpose**: The final response generated by the RAG agent, including answer and source citations.

**Schema**:
```python
class SourceCitation(BaseModel):
    source_url: str
        description: "URL of the source document"
        constraints: "Required"
        example: "https://physical-ai-humanoid-robotics-book-dusky.vercel.app/docs/introduction"

    source_title: str
        description: "Title of the source document"
        constraints: "Required"
        example: "Introduction to Humanoid Robotics"

    content_preview: str
        description: "Preview of the content that was used"
        constraints: "Required, max 200 characters"
        example: "Humanoid robotics involves creating robots with human-like characteristics..."

    relevance_score: float
        description: "Relevance score of this source to the query"
        constraints: "Required, range 0.0-1.0"
        example: 0.85

class AgentResponse(BaseModel):
    answer: str
        description: "The agent's answer to the user's query"
        constraints: "Required"
        example: "Humanoid robotics involves creating robots with human-like characteristics..."

    sources: List[SourceCitation]
        description: "List of sources used to generate the answer"
        constraints: "Required if include_sources was True in request"
        example: "[{...citation1...}, {...citation2...}]"

    confidence_score: float
        description: "Confidence score for the generated answer (0.0-1.0)"
        constraints: "Required, range 0.0-1.0"
        example: 0.92

    tokens_used: int
        description: "Number of tokens used in the response"
        constraints: "Required, positive"
        example: 156

    processing_time_ms: float
        description: "Total time for processing the query in milliseconds"
        constraints: "Required, positive"
        example: 1245.6

    hallucination_detected: bool
        description: "Whether hallucination was detected in the response"
        constraints: "Required, default False"
        example: False
```

**Validation Rules**:
- answer must be non-empty
- confidence_score must be between 0.0 and 1.0
- tokens_used must be positive
- processing_time_ms must be positive
- If include_sources was True in request, sources must not be empty

### 4. API Response Envelope

**Purpose**: Standardized response wrapper for all API endpoints.

**Schema**:
```python
class APIResponse(BaseModel):
    success: bool
        description: "Whether the request was successful"
        constraints: "Required"
        example: True

    data: Optional[Union[AgentResponse, Dict[str, Any]]]
        description: "The response data payload"
        constraints: "Required if success is True"
        example: "{...agent_response...}"

    error: Optional[Dict[str, str]]
        description: "Error information if success is False"
        constraints: "Required if success is False"
        example: {"code": "QUERY_TOO_LONG", "message": "Query exceeds maximum length"}

    request_id: str
        description: "Unique identifier for this request"
        constraints: "Required"
        example: "req_1234567890"

    timestamp: str
        description: "ISO 8601 timestamp of the response"
        constraints: "Required"
        example: "2025-12-24T10:30:00.123Z"
```

**Validation Rules**:
- If success is True, data must be present and error must be null
- If success is False, error must be present and data must be null
- request_id must be a unique identifier
- timestamp must be in ISO 8601 format

## Supporting Entities

### 5. Health Check Response

**Purpose**: System health and status information.

**Schema**:
```python
class HealthStatus(BaseModel):
    status: str
        description: "Overall system health status"
        constraints: "Required, values: 'healthy', 'degraded', 'unhealthy'"
        example: "healthy

    services: Dict[str, str]
        description: "Health status of individual services"
        constraints: "Required"
        example: {"qdrant": "healthy", "openai": "healthy", "api": "healthy"}

    version: str
        description: "Service version"
        constraints: "Required"
        example: "1.0.0"

    uptime_seconds: int
        description: "Service uptime in seconds"
        constraints: "Required, positive"
        example: 3600
```

### 6. Configuration Model

**Purpose**: Runtime configuration parameters.

**Schema**:
```python
class RAGConfig(BaseModel):
    max_query_length: int
        description: "Maximum allowed query length"
        constraints: "Required, positive"
        example: 1000

    max_chunks_per_query: int
        description: "Maximum chunks to retrieve per query"
        constraints: "Required, positive"
        example: 5

    min_similarity_score: float
        description: "Minimum similarity score for retrieved chunks"
        constraints: "Required, range 0.0-1.0"
        example: 0.5

    agent_temperature: float
        description: "Default temperature for agent responses"
        constraints: "Required, range 0.0-1.0"
        example: 0.1

    timeout_seconds: int
        description: "Default timeout for operations"
        constraints: "Required, positive"
        example: 30
```

## Data Flow Patterns

### 1. Query Processing Flow
```
QueryRequest → Validation → Embedding → Qdrant Search → RetrievedContext → Agent Processing → AgentResponse → APIResponse
```

### 2. Error Handling Flow
```
Error Occurs → Error Classification → Error Response → APIResponse(success=False)
```

## Entity Relationships

```
QueryRequest
    ↓ (triggers)
RetrievedContext
    ↓ (used by)
AgentResponse
    ↓ (wrapped in)
APIResponse
```

## Validation Requirements

### 1. Input Validation
- All string inputs must be sanitized for security
- Numeric values must be within specified ranges
- URLs must be properly formatted
- Query content must be validated for appropriate content

### 2. Output Validation
- Agent responses must be checked against source content
- Confidence scores must reflect actual certainty
- Source citations must correspond to actual retrieved content
- No hallucinated information should be present in responses

## Performance Considerations

### 1. Data Size Limits
- Individual chunk content: < 2000 characters
- Total response size: < 1MB
- Number of sources: < 10 per response
- Metadata size: < 1KB per entity

### 2. Processing Constraints
- Embedding operations should be batched when possible
- Retrieved context should be limited to most relevant chunks
- Response generation should have timeout protection
- Validation should be efficient and not impact performance significantly